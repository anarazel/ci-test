env:
  CIRRUS_LOG_TIMESTAMP: true
  GCP_PROJECT: pg-ci-images
  GCP_REPO: us-docker.pkg.dev/$GCP_PROJECT/ci


task:
  matrix:
    - name: test-linux-container-amd64
      container:
        image: $GCP_REPO/linux_debian_bullseye_ci:latest
    - name: test-linux-container-aarch64
      arm_container:
        image: $GCP_REPO/linux_debian_bullseye_ci:latest

  test_script:
    - id
    - uname -a
    #- apt-get update && apt-get install -y curl procps
    - ulimit -a -H
    - ulimit -a -S
    - export
    - cat /proc/sys/kernel/core_pattern
    - cat /proc/sys/kernel/core_uses_pid

  test_core_script:
    - ulimit -c unlimited
    - useradd -m postgres
    - su postgres -c /usr/bin/sleep 3600 &
    - P=$!
    - echo $P
    - sleep 1
    - kill -SEGV $P
    - wait $P || true
    - ls -l core* || true
    - ls -l /*core* || true


task:
  name: test-windows-container-base-amd64
  only_if: false
  windows_container:
    image: $GCP_REPO/windows_ci_base:latest
  test_script:
    - set
    - ver
    - where perl
    - perl --version
    - python --version
    - curl ifconfig.me/all

task:
  name: test-windows-container-vs-2019-amd64
  only_if: false
  windows_container:
    image: $GCP_REPO/windows_ci_vs_2019:latest
  test_script:
    - set
    - dir C:\BuildTools\VC\Auxiliary\Build
    - ver
    - where perl
    - perl --version
    - python --version
    - vcvarsall x64
    - bison --version
    - flex --version
    - curl ifconfig.me/all
